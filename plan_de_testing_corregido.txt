-- =========================================================
-- PLAN DE PRUEBAS MANUAL (RLS + PERMISOS) - 100% FUNCIONAL
-- Ajustado a:
--  - creacion_de_tablas.sql (NOT NULL, checks, etc.)
--  - triggers.sql (calcula subtotales, valida stock, recalcula totales, valida pago exacto)
-- =========================================================
-- Ejecutar con psql (usa \connect, \set, \gset):
--   psql -h localhost -d TU_DB -f plan_pruebas_rls.sql
--
-- Requiere que YA estén ejecutados:
--   1) creacion_de_tablas.sql
--   2) roles.sql (corregido)
--   3) usuarios_y_permisos.sql (corregido)
--   4) RLS.sql
--   5) triggers.sql
-- =========================================================

\set ON_ERROR_STOP on

\echo '========================================================='
\echo '0) CONFIG - AJUSTA EL NOMBRE DE LA BASE'
\echo '========================================================='
\set DBNAME 'TU_DB'
\echo 'DB=' :DBNAME

-- =========================================================
-- 1) SETUP DE DATA MINIMA (como admin)
-- =========================================================
\echo '========================================================='
\echo '1) SETUP (admin): data mínima consistente con TRIGGERS'
\echo '========================================================='

\connect :DBNAME julian_diaz
SELECT current_user, current_role;

-- 1.1 Provincia/Ciudad mínimas
\echo '--- Provincia/Ciudad: asegurar al menos 1 fila'
INSERT INTO Provincia (nombre)
SELECT 'Cordoba'
WHERE NOT EXISTS (SELECT 1 FROM Provincia);

INSERT INTO Ciudad (id_provincia, cp, nombre)
SELECT
  (SELECT provincia_id FROM Provincia ORDER BY provincia_id LIMIT 1),
  '5000',
  'Cordoba Capital'
WHERE NOT EXISTS (SELECT 1 FROM Ciudad);

SELECT ciudad_id FROM Ciudad ORDER BY ciudad_id LIMIT 1 \gset
\echo 'ciudad_id=' :ciudad_id

-- 1.2 Producto mínimo con stock alto (evita fallos de validar_stock_carrito/factura)
\echo '--- Producto: asegurar 1 producto con stock=100 y precio=100'
INSERT INTO Producto (nombre, stock, precio, descripcion)
SELECT 'Producto Test', 100, 100.00, 'Producto para pruebas RLS/permisos'
WHERE NOT EXISTS (SELECT 1 FROM Producto);

SELECT producto_id FROM Producto ORDER BY producto_id LIMIT 1 \gset
\echo 'producto_id=' :producto_id

-- 1.3 Dos usuarios clientes en tabla Usuario (rol=cliente_app para que UPDATE policy pase)
\echo '--- Usuario: asegurar 2 clientes (tabla Usuario)'
INSERT INTO Usuario (nombre, apellido, email, contrasenia, rol)
SELECT 'Ana', 'Perez', 'ana_perez@test.local', 'Password1', 'cliente_app'
WHERE NOT EXISTS (SELECT 1 FROM Usuario WHERE email = 'ana_perez@test.local');

INSERT INTO Usuario (nombre, apellido, email, contrasenia, rol)
SELECT 'Carlos', 'Gomez', 'carlos_gomez@test.local', 'Password2', 'cliente_app'
WHERE NOT EXISTS (SELECT 1 FROM Usuario WHERE email = 'carlos_gomez@test.local');

SELECT usuario_id AS u1 FROM Usuario WHERE email='ana_perez@test.local' \gset
SELECT usuario_id AS u2 FROM Usuario WHERE email='carlos_gomez@test.local' \gset
\echo 'u1=' :u1 ' | u2=' :u2

-- 1.4 Direcciones para ambos
\echo '--- Direccion: asegurar 1 dirección para cada usuario'
INSERT INTO Direccion (id_usuario, id_ciudad, calle)
SELECT :u1, :ciudad_id, 'Calle U1 123'
WHERE NOT EXISTS (SELECT 1 FROM Direccion WHERE id_usuario=:u1);

INSERT INTO Direccion (id_usuario, id_ciudad, calle)
SELECT :u2, :ciudad_id, 'Calle U2 456'
WHERE NOT EXISTS (SELECT 1 FROM Direccion WHERE id_usuario=:u2);

SELECT direccion_id AS dir1 FROM Direccion WHERE id_usuario=:u1 ORDER BY direccion_id LIMIT 1 \gset
SELECT direccion_id AS dir2 FROM Direccion WHERE id_usuario=:u2 ORDER BY direccion_id LIMIT 1 \gset
\echo 'dir1=' :dir1 ' | dir2=' :dir2

-- 1.5 Carritos activos para ambos (fecha_actualizacion >= fecha_creacion)
\echo '--- Carrito: asegurar 1 carrito ACTIVO por usuario'
INSERT INTO Carrito (id_usuario, fecha_creacion, fecha_actualizacion, estado, total)
SELECT :u1, CURRENT_DATE, CURRENT_DATE, 'activo', 0
WHERE NOT EXISTS (SELECT 1 FROM Carrito WHERE id_usuario=:u1);

INSERT INTO Carrito (id_usuario, fecha_creacion, fecha_actualizacion, estado, total)
SELECT :u2, CURRENT_DATE, CURRENT_DATE, 'activo', 0
WHERE NOT EXISTS (SELECT 1 FROM Carrito WHERE id_usuario=:u2);

SELECT carrito_id AS c1 FROM Carrito WHERE id_usuario=:u1 ORDER BY carrito_id LIMIT 1 \gset
SELECT carrito_id AS c2 FROM Carrito WHERE id_usuario=:u2 ORDER BY carrito_id LIMIT 1 \gset
\echo 'c1=' :c1 ' | c2=' :c2

-- 1.6 Reseñas: una por usuario para probar SELECT ALL y UPDATE/DELETE
\echo '--- Reseña: asegurar 1 reseña por usuario en producto test'
INSERT INTO Reseña (id_usuario, id_producto, calificacion, comentario)
SELECT :u1, :producto_id, 5, 'Reseña U1'
WHERE NOT EXISTS (SELECT 1 FROM Reseña WHERE id_usuario=:u1 AND id_producto=:producto_id);

INSERT INTO Reseña (id_usuario, id_producto, calificacion, comentario)
SELECT :u2, :producto_id, 1, 'Reseña U2'
WHERE NOT EXISTS (SELECT 1 FROM Reseña WHERE id_usuario=:u2 AND id_producto=:producto_id);

-- 1.7 Factura + lineaFactura + pago + envio por usuario (compatibles con triggers)
-- Importante:
--  - El trigger calcula subtotal de lineaFactura y actualiza factura.monto_total
--  - El trigger de pago exige monto EXACTAMENTE igual a factura.monto_total (no parcial)
\echo '--- Factura/lineaFactura/Pago/Envio: asegurar 1 factura completa por usuario'

-- Crear facturas con monto_total=0 (luego se recalcula con lineaFactura)
INSERT INTO Factura (id_usuario, monto_total)
SELECT :u1, 0
WHERE NOT EXISTS (SELECT 1 FROM Factura WHERE id_usuario=:u1);

INSERT INTO Factura (id_usuario, monto_total)
SELECT :u2, 0
WHERE NOT EXISTS (SELECT 1 FROM Factura WHERE id_usuario=:u2);

SELECT factura_id AS f1 FROM Factura WHERE id_usuario=:u1 ORDER BY factura_id LIMIT 1 \gset
SELECT factura_id AS f2 FROM Factura WHERE id_usuario=:u2 ORDER BY factura_id LIMIT 1 \gset
\echo 'f1=' :f1 ' | f2=' :f2

-- Insertar lineaFactura (NO insertamos subtotal: trigger lo calcula)
-- precio_unitario lo tomamos del producto para consistencia
INSERT INTO lineaFactura (id_factura, id_producto, precio_unitario, descuento, cantidad, subtotal)
SELECT
  :f1,
  :producto_id,
  (SELECT precio FROM Producto WHERE producto_id=:producto_id),
  0,
  1,
  1  -- placeholder: trigger BEFORE INSERT lo pisa con el subtotal correcto
WHERE NOT EXISTS (SELECT 1 FROM lineaFactura WHERE id_factura=:f1 AND id_producto=:producto_id);

INSERT INTO lineaFactura (id_factura, id_producto, precio_unitario, descuento, cantidad, subtotal)
SELECT
  :f2,
  :producto_id,
  (SELECT precio FROM Producto WHERE producto_id=:producto_id),
  0,
  1,
  1  -- placeholder: trigger BEFORE INSERT lo pisa
WHERE NOT EXISTS (SELECT 1 FROM lineaFactura WHERE id_factura=:f2 AND id_producto=:producto_id);

-- Pagar EXACTO el monto_total (ya recalculado por trigger AFTER en lineaFactura)
-- Si ya existe pago, no insertamos otro para no romper el "exacto"
INSERT INTO Pago (id_factura, monto, metodo)
SELECT :f1, (SELECT monto_total FROM Factura WHERE factura_id=:f1), 'mercadopago'
WHERE NOT EXISTS (SELECT 1 FROM Pago WHERE id_factura=:f1);

INSERT INTO Pago (id_factura, monto, metodo)
SELECT :f2, (SELECT monto_total FROM Factura WHERE factura_id=:f2), 'mercadopago'
WHERE NOT EXISTS (SELECT 1 FROM Pago WHERE id_factura=:f2);

-- Envíos
INSERT INTO Envio (id_direccion, id_factura, estado, costoEnvio)
SELECT :dir1, :f1, 'pendiente', 0
WHERE NOT EXISTS (SELECT 1 FROM Envio WHERE id_factura=:f1);

INSERT INTO Envio (id_direccion, id_factura, estado, costoEnvio)
SELECT :dir2, :f2, 'pendiente', 0
WHERE NOT EXISTS (SELECT 1 FROM Envio WHERE id_factura=:f2);

SELECT envio_id AS e1 FROM Envio WHERE id_factura=:f1 ORDER BY envio_id LIMIT 1 \gset
SELECT envio_id AS e2 FROM Envio WHERE id_factura=:f2 ORDER BY envio_id LIMIT 1 \gset
\echo 'e1=' :e1 ' | e2=' :e2

-- 1.8 LineaCarrito: crear una línea en carrito de U1
-- Importante:
--  - trigger calcula subtotal BEFORE INSERT (aunque subtotal sea NOT NULL)
--  - igual necesitamos pasar un valor para cumplir NOT NULL en el INSERT? NO:
--    en Postgres, si omitís la columna, queda NULL y el trigger puede setearla antes del check.
--    PERO tu check es subtotal > 0 y NOT NULL, el trigger la setea -> OK.
--  - precio_unitario lo tomamos del producto; subtotal lo omitimos.
\echo '--- lineaCarrito: asegurar 1 línea en carrito U1 (trigger calcula subtotal y total del carrito)'
INSERT INTO lineaCarrito (id_carrito, id_producto, cantidad, precio_unitario)
SELECT
  :c1,
  :producto_id,
  1,
  (SELECT precio FROM Producto WHERE producto_id=:producto_id)
WHERE NOT EXISTS (SELECT 1 FROM lineaCarrito WHERE id_carrito=:c1 AND id_producto=:producto_id);

-- =========================================================
-- 2) PRUEBAS ADMIN (julian_diaz / admin_app)
-- =========================================================
\echo '========================================================='
\echo '2) ADMIN: julian_diaz (admin_app) - Debe ver/modificar TODO'
\echo '========================================================='

\connect :DBNAME julian_diaz
SELECT current_user, current_role;

\echo '--- Conteos globales (PASS)'
SELECT COUNT(*) AS usuarios FROM Usuario;
SELECT COUNT(*) AS direcciones FROM Direccion;
SELECT COUNT(*) AS carritos FROM Carrito;
SELECT COUNT(*) AS lineas_carrito FROM lineaCarrito;
SELECT COUNT(*) AS resenas FROM Reseña;
SELECT COUNT(*) AS facturas FROM Factura;
SELECT COUNT(*) AS pagos FROM Pago;
SELECT COUNT(*) AS envios FROM Envio;

\echo '--- Update dummy global (PASS)'
UPDATE Usuario SET nombre = nombre WHERE usuario_id = :u1;

-- =========================================================
-- 3) PRUEBAS CLIENTE (ana_perez / cliente_app)
-- =========================================================
\echo '========================================================='
\echo '3) CLIENTE: ana_perez (cliente_app)'
\echo '========================================================='

\connect :DBNAME ana_perez
SELECT current_user, current_role;

-- 3.1 Sin app.user_id
\echo '--- 3.1 SIN app.user_id -> 0 filas en tablas con RLS (excepto Reseña: SELECT ALL)'
RESET app.user_id;

SELECT COUNT(*) AS usuario_visible FROM Usuario;
SELECT COUNT(*) AS direcciones_visibles FROM Direccion;
SELECT COUNT(*) AS carritos_visibles FROM Carrito;
SELECT COUNT(*) AS lineas_carrito_visibles FROM lineaCarrito;
SELECT COUNT(*) AS favoritos_visibles FROM Favorito;
SELECT COUNT(*) AS facturas_visibles FROM Factura;
SELECT COUNT(*) AS pagos_visibles FROM Pago;
SELECT COUNT(*) AS envios_visibles FROM Envio;

SELECT COUNT(*) AS resenas_visibles FROM Reseña;

-- 3.2 Con app.user_id = U1
\echo '--- 3.2 SET app.user_id = U1 -> propio'
SET app.user_id = :'u1';

\echo '--- Usuario: ver solo U1 (PASS)'
SELECT usuario_id, email, rol FROM Usuario ORDER BY usuario_id;

\echo '--- Usuario: ver U2 (0 filas) (PASS esperado por RLS)'
SELECT usuario_id, email FROM Usuario WHERE usuario_id = :'u2';

\echo '--- Usuario: UPDATE propio (PASS)'
UPDATE Usuario SET apellido = apellido WHERE usuario_id = :'u1';

\echo '--- Usuario: cambiar rol (FAIL por WITH CHECK)'
UPDATE Usuario SET rol = 'admin_app' WHERE usuario_id = :'u1';

\echo '--- Direccion: SELECT propias (PASS)'
SELECT direccion_id, id_usuario, calle FROM Direccion ORDER BY direccion_id;

\echo '--- Direccion: INSERT propia (PASS)'
INSERT INTO Direccion (id_usuario, id_ciudad, calle)
VALUES (:'u1', :ciudad_id, 'Calle Cliente - insert propio');

\echo '--- Direccion: INSERT ajena (FAIL por policy WITH CHECK)'
INSERT INTO Direccion (id_usuario, id_ciudad, calle)
VALUES (:'u2', :ciudad_id, 'Calle HACK - insert ajeno');

\echo '--- Carrito: SELECT propios (PASS)'
SELECT carrito_id, id_usuario, estado, total FROM Carrito ORDER BY carrito_id;

\echo '--- Carrito: INSERT propio (PASS)'
INSERT INTO Carrito (id_usuario, fecha_creacion, fecha_actualizacion, estado, total)
VALUES (:'u1', CURRENT_DATE, CURRENT_DATE, 'activo', 0);

\echo '--- Carrito: INSERT ajeno (FAIL)'
INSERT INTO Carrito (id_usuario, fecha_creacion, fecha_actualizacion, estado, total)
VALUES (:'u2', CURRENT_DATE, CURRENT_DATE, 'activo', 0);

\echo '--- lineaCarrito: SELECT (PASS - solo carritos propios)'
SELECT * FROM lineaCarrito ORDER BY id_carrito, id_producto;

\echo '--- lineaCarrito: INSERT en carrito propio (PASS; subtotal lo calcula trigger)'
INSERT INTO lineaCarrito (id_carrito, id_producto, cantidad, precio_unitario)
VALUES (:'c1', :producto_id, 1, (SELECT precio FROM Producto WHERE producto_id=:producto_id));

\echo '--- lineaCarrito: INSERT en carrito ajeno (FAIL por RLS)'
INSERT INTO lineaCarrito (id_carrito, id_producto, cantidad, precio_unitario)
VALUES (:'c2', :producto_id, 1, (SELECT precio FROM Producto WHERE producto_id=:producto_id));

\echo '--- Favorito: INSERT propio (PASS)'
INSERT INTO Favorito (id_usuario, id_producto)
VALUES (:'u1', :producto_id);

\echo '--- Favorito: INSERT ajeno (FAIL)'
INSERT INTO Favorito (id_usuario, id_producto)
VALUES (:'u2', :producto_id);

\echo '--- Reseña: SELECT ALL (PASS)'
SELECT id_usuario, id_producto, calificacion, comentario FROM Reseña ORDER BY id_producto, id_usuario;

\echo '--- Reseña: UPDATE ajena (FAIL/0 filas)'
UPDATE Reseña
SET comentario = 'Edit ajeno - DEBE FALLAR'
WHERE id_usuario = :'u2' AND id_producto = :producto_id;

\echo '--- Factura/lineaFactura/Pago/Envio: SELECT propio (PASS, solo propias)'
SELECT factura_id, id_usuario, monto_total FROM Factura ORDER BY factura_id;
SELECT id_factura, id_producto, subtotal FROM lineaFactura ORDER BY id_factura;
SELECT pago_id, id_factura, monto, metodo FROM Pago ORDER BY pago_id;
SELECT envio_id, id_factura, estado FROM Envio ORDER BY envio_id;

\echo '--- Factura: INSERT (FAIL por permisos GRANT en cliente_app)'
INSERT INTO Factura (id_usuario, monto_total)
VALUES (:'u1', 50.00);

-- =========================================================
-- 4) PRUEBAS OPERADOR_COMERCIAL (fernando_rossi / operador_comercial)
-- =========================================================
\echo '========================================================='
\echo '4) OPERADOR_COMERCIAL: fernando_rossi (operador_comercial)'
\echo '========================================================='

\connect :DBNAME fernando_rossi
SELECT current_user, current_role;

\echo '--- SELECT global en tablas con RLS (PASS por policies SELECT true)'
SELECT COUNT(*) AS usuarios FROM Usuario;
SELECT COUNT(*) AS carritos FROM Carrito;
SELECT COUNT(*) AS resenas FROM Reseña;
SELECT COUNT(*) AS facturas FROM Factura;

\echo '--- UPDATE Producto (PASS)'
UPDATE Producto
SET descripcion = descripcion
WHERE producto_id = :producto_id;

\echo '--- INSERT Promocion (PASS; titulo es NOT NULL)'
INSERT INTO Promocion (id_producto, fechaInicio, fechaFin, titulo, descripcion, descuento, activa)
VALUES (:producto_id, CURRENT_DATE, CURRENT_DATE + 7, 'Promo Test', 'Promo para pruebas', 10, true);

\echo '--- DELETE Usuario (FAIL por permisos GRANT)'
DELETE FROM Usuario WHERE usuario_id = :u1;

-- =========================================================
-- 5) PRUEBAS OPERADOR_LOGISTICA (hernan_torres / operador_logistica)
-- =========================================================
\echo '========================================================='
\echo '5) OPERADOR_LOGISTICA: hernan_torres (operador_logistica)'
\echo '========================================================='

\connect :DBNAME hernan_torres
SELECT current_user, current_role;

\echo '--- SELECT global en tablas con RLS (PASS por policies SELECT true)'
SELECT COUNT(*) AS usuarios FROM Usuario;
SELECT COUNT(*) AS direcciones FROM Direccion;
SELECT COUNT(*) AS facturas FROM Factura;
SELECT COUNT(*) AS envios FROM Envio;

\echo '--- UPDATE SOLO stock en Producto (PASS)'
UPDATE Producto
SET stock = stock + 1
WHERE producto_id = :producto_id;

\echo '--- UPDATE precio (FAIL: solo UPDATE(stock))'
UPDATE Producto
SET precio = precio + 1
WHERE producto_id = :producto_id;

\echo '--- UPDATE Envio (PASS; trigger valida transición, este update no cambia estado)'
UPDATE Envio
SET estado = estado
WHERE envio_id = :e1;

\echo '--- INSERT Direccion (FAIL por permisos: solo SELECT en Direccion)'
INSERT INTO Direccion (id_usuario, id_ciudad, calle)
VALUES (:u1, :ciudad_id, 'No debería - operador_logistica');

\echo '========================================================='
\echo 'FIN DEL PLAN DE PRUEBAS'
\echo '========================================================='

